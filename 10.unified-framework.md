---
title: Unified Framework
numbering:
  enumerator: 10.%s
label : algo_page
---

- The virtual BF deconvolution framework essentially maps to other direct WPOA methods:
  - Optimum BF STEM (OBF) [@https://doi.org/10.1016/j.ultramic.2020.113133]
  - Matched-filter STEM (MF) [@https://doi.org/10.5281/zenodo.18449974]
    - Wigner distribution deconvolution (WDD) [@https://doi.org/10.1098/rsta.1992.0050]
  - Center of mass imaging (iCOM) [@https://doi.org/10.1016/j.ultramic.2015.10.011]

::::::::{prf:algorithm} Unified Direct Ptychography Framework

:::{dropdown} Inputs
- 4D-STEM dataset $I(\mathbf r,\mathbf k)$  
- Estimator type $\in \{\text{SSB},\text{OBF},\text{MF},\text{prlx},\text{iCOM}\}$  
- Integer upsampling factor $f$  
- Aberration coefficients $C_{n,m}$ (for $\chi$ and $\nabla_{\mathbf k}\chi$)  
- Convergence semiangle $k_0$  
- Scan/detector rotation angle $\theta$
:::

:::{dropdown} Output
- Estimated phase $\phi(\mathbf r')$, upsampled by factor $f$
:::

::::{dropdown} Initialization

1. Allocate upsampled output array  
  :::{math}
  I'(\mathbf r') \leftarrow 0
  :::

2. Define bright-field index set  
  :::{math}
  \mathbf k_{\mathrm{BF}} = \{\mathbf k : |\mathbf k| < k_0\}
  :::

3. Extract bright-field stack  
  :::{math}
  I_{\mathrm{BF}}
  = \{ I(\mathbf r,\mathbf k) : \mathbf k \in \mathbf k_{\mathrm{BF}} \}
  :::

4. Construct $f$-upsampled, $\theta$-rotated spatial-frequency grid $\mathbf q'$

::::

:::::::{dropdown} Reconstruction

For each BF index $i = 1,\dots,N_{\mathrm{BF}}$:

1. Compute Fourier transform of the virtual BF image  
  :::{math}
  G(\mathbf q)
  \leftarrow
  \mathcal F_{\mathbf r\rightarrow\mathbf q}
  \big[ I_{\mathrm{BF}}^{(i)}(\mathbf r) \big]
  :::
  *(Fourier transform of vBF image)*

2. Upsample by Fourier tiling  
  :::{math}
  G(\mathbf q')
  \leftarrow
  \operatorname{tile}_f\!\left[ G(\mathbf q) \right]
  :::
  *(Integer upsampling via frequency tiling)*

3. Compute estimator kernel $H(\mathbf q')$:

:::::{tab-set}

::::{tab-item} single sideband
:::{math}
H(\mathbf q')
= -\,i\,\frac{\Gamma^*(\mathbf q',\mathbf k_{\mathrm{BF}})}
              {|\Gamma(\mathbf q',\mathbf k_{\mathrm{BF}})|}
:::
::::

::::{tab-item} optimum BF
:::{math}
H(\mathbf q')
= -\,i\,\frac{\Gamma^*(\mathbf q',\mathbf k_{\mathrm{BF}})}
              {\sqrt{\sum_{\mathbf k\in\mathbf k_{\mathrm{BF}}}
              |\Gamma(\mathbf q',\mathbf k)|^2}}
:::
::::

::::{tab-item} matched filter
:::{math}
H(\mathbf q')
= -\,i\,\frac{\Gamma^*(\mathbf q',\mathbf k_{\mathrm{BF}})}
              {\sum_{\mathbf k\in\mathbf k_{\mathrm{BF}}}
              |\Gamma(\mathbf q',\mathbf k)|^2 + \epsilon(\mathbf q')}
:::
::::

::::{tab-item} parallax
:::{math}
H(\mathbf q')
= e^{-i\,\nabla_{\mathbf k}\chi(\mathbf k_{\mathrm{BF}})
      \cdot \mathbf q'}
\;\mathrm{sgn}\!\big[\sin\chi(\mathbf q')\big]
:::
::::

::::{tab-item} center of mass
:::{math}
H(\mathbf q')
= -\,i\,\frac{\mathbf k_{\mathrm{BF}}\cdot\mathbf q'}
              {|\mathbf q'|^2}
:::
::::

:::::

4. Apply kernel and accumulate contribution  
  :::{math}
  I'(\mathbf r') \;{+}{=}\;
  \frac{1}{N_{\mathrm{BF}}}
  \operatorname{Re}\!\left\{
  \mathcal F^{-1}_{\mathbf q'\rightarrow\mathbf r'}
  \big[ G(\mathbf q')\,H(\mathbf q') \big]
  \right\}
  :::

End for

:::::::

::::::::

:::::{tab-set}
::::{tab-item} Transfer of Information
:::{figure} ./figures/direct-ctf-figure.svg
Contrast transfer functions (CTFs) and spectral signal-to-noise (SSNRs) for all direct techniques, highlighting the SSNR equivalence for SSB, OBF, and MF/WDD [@https://doi.org/10.5281/zenodo.18449974]. 
:::
::::


::::{tab-item} Experimental Reconstructions

:::{figure}
:label: fig_experimental_unified

:::{image} ./figures/mos2_inset.png
:::

:::{image} ./figures/gold_inset.png
:::

Experimental twisted MoS2 and gold nanoparticles reconstructions using various direct ptychography kernels [@10.1126/science.adw7751; @https://doi.org/10.5281/zenodo.18449974].

::::

:::::